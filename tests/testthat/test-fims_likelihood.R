# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# fims_likelihood ----
## Setup ----
# Load or prepare any necessary data for testing
# clear memory
clear()
## Testing how to remove one year of data and run multiple FIMS models
# Load sample data
data("data1")
# Prepare data for FIMS model
data_4_model <- FIMSFrame(data1)
# Create parameters
parameters <- data_4_model |>
  create_default_configurations() |>
  create_default_parameters(data = data_4_model)

# Run the  model with optimization
base_model <- parameters |>
  initialize_fims(data = data_4_model) |>
  fit_fims(optimize = TRUE)


## IO correctness ----
# test values that are returned
# test objects that are returned
test_that("fims_likelihood() works with correct inputs", {
  #' @description Test that fims_likelihood(x) returns y.
  
  like_fit <- run_fims_likelihood(
    model = base_model,
    parameters = parameters,
    data = data1,
    n_cores = 1,
    min = -1,
    max = 1,
    length = 3
  )
  expect_equal(
    object = names(like_fit),
    expected = c("vec", "estimates")
  )

  #' @description Test that fims_likelihood(x) returns y.
  expect_equal(
    object = length(like_fit[["vec"]]),
    expected = 3
  )

### add total likelihood across all groups (TODO: turned off for now while we sort out new group column)
  total <- like_fit$estimates |>
    dplyr::filter(!is.na(lpdf)) |>
    dplyr::group_by(value_log_rzero) |>
    dplyr::distinct(lpdf) |>
    dplyr::summarise(total_like = sum(lpdf)) |> # negative to make negative log likelihood
    dplyr::mutate(label = "Total") |>
    dplyr::select(value_log_rzero, label, total_like)

  #' @description Test that fims_likelihood(x) returns y.
  expect_equal(
    object = total$total_like[1],
    expected = -3231.052
  )

})

## Edge handling ----
test_that("run_fims_likelihood() handles edge cases correctly", {
  #' @description Test that run_fims_likelihood works with minimum valid length = 1.
  like_fit_min <- run_fims_likelihood(
    model = base_model,
    parameters = parameters,
    data = data1,
    n_cores = 1,
    min = -1,
    max = 1,
    length = 1
  )
  expect_equal(
    object = length(like_fit_min[["vec"]]),
    expected = 1
  )
  
  #' @description Test that run_fims_likelihood works with n_cores = 1 (sequential).
  like_fit_seq <- run_fims_likelihood(
    model = base_model,
    parameters = parameters,
    data = data1,
    n_cores = 1,
    min = -0.5,
    max = 0.5,
    length = 2
  )
  expect_equal(
    object = length(like_fit_seq[["vec"]]),
    expected = 2
  )
})

cli::test_that_cli("run_fims_likelihood() shows warning when min and max don't span 0", {
  #' @description Test that run_fims_likelihood() shows warning when min and max don't span 0.
  expect_snapshot(
    run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 1,
      min = 0.1,
      max = 0.2,
      length = 2
    )
  )
})

cli::test_that_cli("run_fims_likelihood() shows warning for large length", {
  #' @description Test that run_fims_likelihood() shows warning when length > 50.
  expect_snapshot(
    run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 1,
      min = -0.1,
      max = 0.1,
      length = 51
    )
  )
})

## Error handling ----
test_that("run_fims_likelihood() returns correct error messages", {
  #' @description Test that run_fims_likelihood errors with invalid length (negative).
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 1,
      length = -1
    ),
    regexp = "should be a positive integer"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid length (zero).
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 1,
      length = 0
    ),
    regexp = "should be a positive integer"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid length (non-integer).
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 1,
      length = 3.5
    ),
    regexp = "should be a positive integer"
  )
  
  #' @description Test that run_fims_likelihood errors when min >= max.
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 1,
      min = 1,
      max = 0
    ),
    regexp = "min should be less than max"
  )
  
  #' @description Test that run_fims_likelihood errors when min == max.
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 1,
      min = 1,
      max = 1
    ),
    regexp = "min should be less than max"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid n_cores (non-integer).
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 2.5,
      length = 3
    ),
    regexp = "n_cores must be a positive integer"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid n_cores (zero).
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = 0,
      length = 3
    ),
    regexp = "n_cores must be a positive integer"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid n_cores (negative).
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      n_cores = -1,
      length = 3
    ),
    regexp = "n_cores must be a positive integer"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid model class.
  expect_error(
    object = run_fims_likelihood(
      model = list(fake = "model"),
      parameters = parameters,
      data = data1,
      n_cores = 1,
      length = 3
    ),
    regexp = "needs to be a FIMSFit object"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid module_name.
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      module_name = "nonexistent_module",
      parameter_name = "log_rzero",
      n_cores = 1,
      length = 3
    ),
    regexp = "module_name not found"
  )
  
  #' @description Test that run_fims_likelihood errors with invalid parameter_name.
  expect_error(
    object = run_fims_likelihood(
      model = base_model,
      parameters = parameters,
      data = data1,
      parameter_name = "nonexistent_parameter",
      n_cores = 1,
      length = 3
    ),
    regexp = "did not match any rows"
  )
})
