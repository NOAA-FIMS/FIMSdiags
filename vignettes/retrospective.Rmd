---
title: "Running a retrospective analysis on a FIMS model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{retrospective}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(FIMSdiags)
library(FIMS)
devtools::load_all()
clear()
```


## Set up FIMS model  
Following the minimal demo vignette, we will set up a FIMS model and run it.  

```{r run_fims_model}
# Load sample data
data("data1")
# Prepare data for FIMS model
data_4_model <- FIMSFrame(data1)

# Create parameters
parameters <- data_4_model |>
  create_default_configurations() |>
  create_default_parameters(data = data_4_model)

# Run the  model with optimization
base_model <- parameters |>
  initialize_fims(data = data_4_model) |>
  fit_fims(optimize = TRUE)

# Clear memory post-run
clear()
```

```{r retro}
retro_fit <- run_fims_likelihood(years_to_remove = 0:2, data_4_model, parameters)

# plot the SSB time series from each model
# NOTE: this doesn't work because we don't have a year value.
#       there's a time column but it's empty
library(ggplot2)
ggplot(estimates_df, aes(x = year, y = estimate, color = retro_year)) +
    geom_line() +
    labs(
        title = "SSB Time Series by Year Removed",
        x = "Year",
        y = "SSB Estimate"
    ) +
    theme_minimal()


# get SSB time series from each model
# using head(10) because the range of years is different among models
SSBtable <- cbind(
    fits[[1]]@estimates |>
        dplyr::filter(label == "SSB") |>
        dplyr::pull(estimate) |>
        head(10),
    fits[[2]]@estimates |>
        dplyr::filter(label == "SSB") |>
        dplyr::pull(estimate) |>
        head(10),
    fits[[3]]@estimates |>
        dplyr::filter(label == "SSB") |>
        dplyr::pull(estimate) |>
        head(10)
)

# proof that values are different among models
SSBtable
#         [,1]     [,2]     [,3]
# SSB 6838.698 6825.748 6818.862
# SSB 6839.828 6827.363 6819.676
# SSB 6790.398 6778.632 6769.959
# SSB 6590.985 6580.053 6570.594
# SSB 6334.694 6324.161 6314.831
# SSB 6120.571 6110.624 6103.179
# SSB 6058.196 6047.160 6042.686
# SSB 5568.276 5556.572 5554.346
# SSB 4569.733 4557.078 4556.954
# SSB 4711.758 4698.478 4701.322

```