---
title: "Running a retrospective analysis on a FIMS model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Running a retrospective analysis on a FIMS model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 9,
  fig.height = 7,
  out.width = "100%"
)
```

```{r setup}
#library(FIMSdiags)
library(FIMS)
packageVersion("FIMS")
devtools::load_all()
clear()
```


## Set up FIMS model  
Following the [minimal FIMS demo vignette](https://noaa-fims.github.io/FIMS/articles/fims-demo-minimal.html), we will set up a FIMS model and run it. This model will contain the all years of data and will be our reference model (see section below for more information about reference models). For this example we are using the dataset included in the FIMS package and creating a set of default parameters. 

```{r run_fims_model}
# Load sample data
data("data1")
# Prepare data for FIMS model
data_4_model <- FIMSFrame(data1)

# Create parameters
parameters <- data_4_model |>
  create_default_configurations() |>
  create_default_parameters(data = data_4_model)

# Run the  model with optimization
base_model <- parameters |>
  initialize_fims(data = data_4_model) |>
  fit_fims(optimize = TRUE)

# Clear memory post-run
clear()
```

## Retrospective analysis  
A retrospective analysis is a common model diagnostic used to assess how stable model estimates such as spawning biomass and fishing mortality are and if there is a consistent pattern in the estimates as years of data are removed. The process involves removing *n* years of data from the end of the time series and refitting the model. This is an iterative process where the user typically runs 5-10 models, with each run (often called "peels") progressively removing another year of data. Derived quantities such as spawning biomass, fishing mortality (F), and recruitment over the years of included data are compared to the model run with the full dataset (reference model). The Mohn's rho statistic can be used to compare the relative difference between the reference model and each peel. Mohn's rho statistic is calculated as: 

$$\rho = \frac{1}{n} \sum_{i=1}^{n} \frac{x_{p,y} - x_{base,y}}{x_{base,y}}$$

where $n$ is the number of retrospective peels, $x_{p, y}$ is the estimated value (e.g. spawning biomass, fishing mortality, etc.) from peel $p$ at its terminal year $y$, and $x_{base,y}$ is the value from the reference model, $base$, at that same year $y$.

Some things to note about the  `run_fims_retrospective()` function, you can provide data that is already a `FIMSFrame` object or you can give it one that is not. In the example below, we are using the `FIMSFrame` data object (`data_4_model`) created above. Additionally, it expects a vector of positive values of `years_to_remove` from the base model, starting from 0. If you are running many peels, it may be more efficient to use multiple cores, which can be specified by the `n_cores` argument. 

::: {.callout-warning}
## Note

If left empty, the default for `n_cores` is one less than the number of cores on your machine so this could unexpectedly use up a lot of your computing power. 
:::

```{r, retro}
retro_fit <- run_fims_retrospective(years_to_remove = 0:2, 
              data_4_model, parameters, 
              n_cores = 1)

```

## Visualize the results  
To visualize the results of the retrospective analysis, we can use `plot_retrospective` to display the quantity of interest. Below, we want to assess the impact on spawning biomass. The function returns a `ggplot` object so to customize the default figure, you can add layers as you normally would to a `ggplot`. For example, below, we specify the x and y axes labels and the legend title. 

::: {.callout-caution}
## Under development

We are actively working on expanding which quantities can be visualized with the `plot_retrospective` function but for now, it is limited to `spawning_biomass`. 
:::

```{r}
# plot the SSB time series from each model
plot_retrospective(retro_fit) + 
ggplot2::labs(x = "Year", y = "Spawning Biomass") +
ggplot2::guides(fill = ggplot2::guide_legend(title = "Retro Peel"), 
color = ggplot2::guide_legend(title = "Retro Peel"),
linetype = ggplot2::guide_legend(title = "Retro Peel"))
```

We can compare the spawning biomass estimates from the reference model and each peel for the last six years. 
```{r}
retro_fit[["estimates"]] |>
    dplyr::filter(label == "spawning_biomass") |>
    dplyr::select(label, year_i, estimated, retrospective_peel) |>
    tidyr::pivot_wider(names_from = retrospective_peel, values_from = estimated) |>
    dplyr::rename(
      "Year" = year_i,
      "Reference model" = `0`,
      "Peel 1" = `1`,
      "Peel 2" = `2`
    ) |>
    tail() 
   
```

## Clean up 
Once you have finished running a FIMS model, it is always good practice to clear the C++ memory from one FIMS model run to the next.
```{r}
clear()
```
